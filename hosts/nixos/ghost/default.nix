#############################################################
#
#  Ghost - Main Desktop
#  NixOS running on Ryzen 9 5900XT, Radeon RX 9070 XT, 64GB RAM
#
###############################################################

{
  inputs,
  lib,
  config,
  pkgs,
  ...
}:
{
  imports = lib.flatten [
    #
    # ========== Hardware ==========
    #
    inputs.nixos-facter-modules.nixosModules.facter
    { config.facter.reportPath = ./facter.json; }
    (lib.custom.scanPaths ./.) # Load all extra host-specific *.nix files

    #
    # ========== Disk Layout ==========
    #
    inputs.disko.nixosModules.disko
    (lib.custom.relativeToRoot "hosts/common/disks/ghost.nix")

    #
    # ========== Modules ==========
    #
    (map lib.custom.relativeToRoot (
      # ========== Required modules ==========
      [
        "hosts/common/core"
      ]
      ++
        # ========== Optional common modules ==========
        (map (f: "hosts/common/optional/${f}") [
          # Desktop environment and login manager
          "hyprland.nix" # enable as service below
          "gnome.nix" # window manager

          # Services
          "services/bluetooth.nix" # bluetooth, blueman and bluez via wireplumber
          "services/logrotate.nix" # log rotation
          "services/openssh.nix" # allow remote SSH access
          "services/printing.nix" # CUPS

          # Misc
          "amdgpu_top.nix" # GPU monitor (not available in home-manager)
          "audio.nix" # pipewire and cli controls
          "gaming.nix" # window manager
          "fonts.nix" # fonts
          "libvirt.nix" # vm tools
          "mail.nix" # for sending email notifications
          "nvtop.nix" # GPU monitor (not available in home-manager)
          "obsidian.nix" # wiki
          "plymouth.nix" # boot graphics
          "protonvpn.nix" # vpn
          "scanning.nix" # SANE and simple-scan
          "thunar.nix" # gui file manager
          "vlc.nix" # media player
          "wayland.nix" # wayland components and pkgs not available in home-manager
          "yubikey.nix" # yubikey related packages and configs
          "zsa-keeb.nix" # Moonlander keeb flashing stuff
        ])
    ))
  ];
  introdus.services = {
    sddm.enable = true;
    x11.enable = true;
  };

  hardware = {
    graphics.package = pkgs.unstable.mesa;
    graphics.package32 = pkgs.unstable.pkgsi686Linux.mesa; # force the same mesa for when steams requires separate system32 mesa dep
  };

  console.earlySetup = lib.mkDefault true;

  boot.initrd = {
    systemd.enable = true;
    kernelModules = [
      "amdgpu"
    ];
  };

  boot.loader = {
    systemd-boot = {
      enable = true;
      # When using plymouth, initrd can expand by a lot each time, so limit how many we keep around
      configurationLimit = lib.mkDefault 10;
      consoleMode = "max";
    };
    efi.canTouchEfiVariables = true;
    timeout = 3;
  };
  boot = {
    kernelParams = [
      "amdgpu.ppfeaturemask=0xfffd3fff" # https://kernel.org/doc/html/latest/gpu/amdgpu/module-parameters.html#ppfeaturemask-hexint
      "amdgpu.dcdebugmask=0x400" # Allegedly might help with some crashes
      "split_lock_detect=off" # Alleged gaming perf increase
      "amdgpu.modeset=1" # explicitly have driver perform KMS (Kernel Mode Setting) during initialization to get higher resolution console output during boot
    ]
    ++ (lib.map (
      m: "video=${m.name}:${toString m.width}x${toString m.height}@${toString m.refreshRate}"
    ) config.monitors);

    # Fix for XBox controller disconnects
    extraModprobeConfig = ''options bluetooth disable_ertm=1 '';
  };

  #FIXME: move to ./disks.nix when we add the disks module
  # needed to unlock LUKS on secondary drives
  # use partition UUID
  # https://wiki.nixos.org/wiki/Full_Disk_Encryption#Unlocking_secondary_drives
  environment.etc.crypttab.text = lib.optionalString (!config.hostSpec.isMinimal) ''
    cryptextra UUID=d90345b2-6673-4f8e-a5ef-dc764958ea14 /luks-secondary-unlock.key
    cryptvms UUID=ce5f47f8-d5df-4c96-b2a8-766384780a91 /luks-secondary-unlock.key
  '';

  environment.systemPackages = lib.attrValues {
    inherit (pkgs.unstable)
      vulkan-tools # vulkaninfo
      ;
  };

  services.backup = {
    enable = true;
    borgBackupStartTime = "02:00:00";

    borgServer = "${config.hostSpec.networking.subnets.grove.hosts.moth.ip}";
    borgUser = "${config.hostSpec.username}";
    borgPort = "${toString config.hostSpec.networking.ports.tcp.moth}";

    borgRemotePath = "/run/current-system/sw/bin/borg";

    borgBackupPath = "/mnt/storage/backup/${config.hostSpec.username}";
    borgNotifyFrom = "${config.hostSpec.email.notifier}";
    borgNotifyTo = "${config.hostSpec.email.backup}";
  };

  # Connect our NUT client to the UPS on the network
  services.ups = {
    client.enable = true;
    name = "cyberpower";
    username = "nut";
    ip = config.hostSpec.networking.subnets.grove.hosts.moth.ip;
    powerDownTimeOut = (60 * 30); # 30m. UPS reports ~45min
  };
}
